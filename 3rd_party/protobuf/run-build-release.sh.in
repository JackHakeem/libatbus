#!/bin/bash

3RD_PARTY_PROTOBUF_BUILD_DIR="@3RD_PARTY_PROTOBUF_PKG_DIR@/deps/protobuf-@3RD_PARTY_PROTOBUF_VERSION@/build_jobs_dir_@PLATFORM_BUILD_PLATFORM_NAME@" ;
3RD_PARTY_PROTOBUF_HOST_BUILD_DIR="@3RD_PARTY_PROTOBUF_PKG_DIR@/deps/protobuf-@3RD_PARTY_PROTOBUF_VERSION@/build_jobs_dir_@PLATFORM_BUILD_HOST_PLATFORM_NAME@" ;

# build host protoc first
if [ "@CMAKE_SYSTEM@" != "@CMAKE_HOST_SYSTEM@" ]; then
    export PATH="$3RD_PARTY_PROTOBUF_HOST_BUILD_DIR:$PATH" ;

    if [ ! -e "$3RD_PARTY_PROTOBUF_HOST_BUILD_DIR" ]; then
        mkdir -p "$3RD_PARTY_PROTOBUF_HOST_BUILD_DIR" ;    
    fi

    cd "$3RD_PARTY_PROTOBUF_HOST_BUILD_DIR" ;

    @3RD_PARTY_PROTOBUF_BUILD_FLAGS_CMD@ "-DCMAKE_INSTALL_PREFIX=@3RD_PARTY_PROTOBUF_HOST_ROOT_DIR@" ;

    @CMAKE_COMMAND@ --build . --target install --config Release @3RD_PARTY_PROTOBUF_BUILD_MULTI_CORE@ ;

else
    export PATH="$3RD_PARTY_PROTOBUF_BUILD_DIR:$PATH" ;
fi

if [ ! -e "$3RD_PARTY_PROTOBUF_BUILD_DIR" ]; then
    mkdir -p "$3RD_PARTY_PROTOBUF_BUILD_DIR" ;    
fi

cd "$3RD_PARTY_PROTOBUF_BUILD_DIR@" ;

if [ "@CMAKE_SYSTEM@" != "@CMAKE_HOST_SYSTEM@" ]; then

    @3RD_PARTY_PROTOBUF_BUILD_FLAGS_CMD@ "-DCMAKE_INSTALL_PREFIX=@3RD_PARTY_PROTOBUF_ROOT_DIR@" -Dprotobuf_BUILD_CONFORMANCE=OFF -Dprotobuf_BUILD_PROTOC_BINARIES=OFF ;

else

    @3RD_PARTY_PROTOBUF_BUILD_FLAGS_CMD@ "-DCMAKE_INSTALL_PREFIX=@3RD_PARTY_PROTOBUF_ROOT_DIR@" ;

fi

@CMAKE_COMMAND@ --build . --target install --config Release @3RD_PARTY_PROTOBUF_BUILD_MULTI_CORE@ ;

